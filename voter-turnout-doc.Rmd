---
title: "Impact of Voter Age on Election Outcomes"
author: "Hans Quiogue and Jackson Callaghan"
date: "5/3/2020"
output: html_document
runtime: shiny
---

```{r Libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(readxl)
library(pander)
library(forecast)
library(DT)
library(reshape2)
library(kableExtra)
```

```{r Data Cleaning for Historical Data, message=FALSE, warning=FALSE, include=FALSE}
# Uncleaned historical data
hist_df <- read_xlsx("a1.xlsx", skip = 5, na = "NA")
# Different voting category names to put into columns for the dataframe
voting_col_names <- c("Year", "Population-Count", "Population-Percent",
                      "Citizen-Percent", "White-Percent", "Citizen-White-Percent", 
                      "White-Non-Hispanic-Percent", "Citizen-White-Non-Hispanic-Perc", 
                      "Black-Percent", "Citizen-Black-Percent", "Asian-Percent",
                      "Citizen-Asian-Percent", "Hispanic/Other-Percent",
                      "Citizen-Hispanic/Other-Perc", "Male-Percent", "Female-Percent")
# Assigns proper column names 
colnames(hist_df) <- voting_col_names
# Converts all columns to numeric
hist_df[] <- lapply(hist_df, function(x) as.numeric(x))
# Converts year column to a categorical value
hist_df$Year <- as.factor(hist_df$Year)

# 1964 to 2018 (Goes by every 2 year)
years_length <- (2018 - 1964) / 2
# List of proper age groups and voting status to put into dataframe
age_groups <- c("Total", "18 to 24", "25 to 44", "45 to 64", "65+")
vote_status <- c("Voted", "Registered")

temp_df <- data.frame()

# Integer values representing current index values of corresponding list
curr_status <- 1
curr_age <- 1

# Loop to cleans up hist_df (Loop increments are added by 6 to account for missing columns)
for(i in seq(1, nrow(hist_df), years_length + 6)) {
  # Appends new rows to temp_df from subset of hist_df
  if(i != 1) temp_df <- bind_rows(temp_df, hist_df[(i - 1):((i - 1) + years_length), ])
  else temp_df <- bind_rows(temp_df, hist_df[i:(i + years_length), ])
}

# Appends new columns for age groups and voting statuses
temp_df <- data.frame(append(temp_df, c(Age = age_groups[curr_status], 
                                        Status = vote_status[curr_age]),
                                        after = 0), stringsAsFactors = FALSE)

temp_index = 1
# Loop that corrects age group and voting status rows
for(i in 1:(length(age_groups) * length(vote_status))) {
  temp_df$Age[temp_index:(temp_index + years_length)] <- age_groups[curr_age]
  temp_df$Status[temp_index:(temp_index + years_length)] <- vote_status[curr_status]
  temp_index <- (temp_index + years_length) + 1
  # Updates age group and voting status to match rows
  if(curr_status == 1) curr_status = curr_status + 1
  else {
    curr_status = 1
    curr_age = curr_age + 1
  }
}
# Removes unnessary rows at the nd
hist_df <- temp_df[1:279, ]

hist_df$Age <- as.factor(hist_df$Age)
hist_df$Status <- as.factor(hist_df$Status)
```

TODO (Intro stuff here): "A description of what you project is about and an overview of what you did. Include the main learning goal or research question." Voter turnout intro stuff blah blah

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
years_label <- ggplot2:::interleave(seq(1964,2018,4), "")

hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  mutate(voted_count = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  geom_point(aes(Year, Population.Count, group = Age, color = "Eligible Population")) +
  geom_line(aes(Year, Population.Count, group = Age, color = "Eligible Population")) +
  geom_point(aes(Year, voted_count, group = Age, color = "Total Vote Count")) +
  geom_line(aes(Year, voted_count, group = Age, color = "Total Vote Count")) +
  ggtitle("Comparison Between Eligible Voters and Vote Count") +
  ylab("Total Population Count (In Thousands)") + 
  xlab("Years") + 
  labs(color = "Groups") +
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

# TODO: Match colors from previous plot (Make blue)
hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  ggplot() +
    aes(Year, Population.Percent, group = Age, color = Age) + 
    geom_point() + geom_line() +
    ggtitle("Total Voting Percentage Over the Years") +
    ylab("Percentage") + 
    xlab("Years") + 
    scale_x_discrete(labels = years_label) +
    theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  ggplot() +
    aes(Year, Population.Percent, group = Age, color = Age) + 
    geom_point() + geom_smooth() +
    ggtitle("Total Voting Percentage Over the Years") +
    ylab("Percentage") + 
    xlab("Years") + 
    scale_x_discrete(labels = years_label) +
    theme(plot.title = element_text(hjust = .5))
```

Based on the plots above, voter turnout has been steadily increasing over the years, but the gap between the total population who are eligible to vote and turnout are widening. The percentage of votes over the years has also dropped. Looking for the potential problems in voter turnout, we wanted to focus on different demographics, specifically age groups.

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
plot_title <- paste("Age Groups that Voted in the U.S. (1964-2018)")
count_label <- paste("Total Voted Count (In Thousands)")

hist_df %>% 
  filter(Status == "Voted" & Age != "Total") %>% 
  mutate(test = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  aes(Year, test, group = Age, color = Age) + 
  geom_point() + geom_line() + 
  ggtitle(plot_title) +
  ylab(count_label) + 
  xlab("Years") + 
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Status == "Voted" & Age != "Total") %>% 
  mutate(test = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  aes(Year, test, group = Age, color = Age) + 
  geom_point() + geom_smooth() + 
  ggtitle(plot_title) +
  ylab(count_label) + 
  xlab("Years") + 
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

hist_df %>%
  filter(Status == "Voted" & Age != 'Total') %>% 
  ggplot() +
  aes(Age, Population.Percent, fill = Age) +
  geom_boxplot() +
  ggtitle("Mean Voting Percentages Between Age Groups") + 
  ylab("Mean Voting Percentage") +
  xlab("Age Groups") + 
  theme(plot.title = element_text(hjust = .5))

mean_table <- hist_df %>% 
  filter(Status == "Voted") %>% 
  group_by(Age) %>% 
  summarize(`Mean of Age Groups` = mean(Population.Percent)) %>% 
  rename(`Age Groups` = Age)
datatable(mean_table)
```

From the plots, it seems that young voters seem to have the least turnout compared to other groups. 

## Interactive Plots on Voting and Registration Berween Age Groups

```{r Overall Votes and Registration, echo=FALSE, message=FALSE, warning=FALSE}
inputPanel(
  selectInput("plot_change", "Choose a plot:", 
              choices = list("Total Count" = 1, 
                              "Percentage" = 2),
              selected = 1),
  checkboxGroupInput("hist_ages", "Choose an age group:",
                      choices = list("Total" = 1,"Young" = 2,
                                     "Adult" = 3,"Mid Age" = 4,
                                     "Elderly" = 5),
                      selected = c(1, 2, 3, 4, 5)),
  radioButtons("hist_status", "Choose voting status:",
               choices = list("Voted" = 1, "Registered" = 2),
               selected = 1),
  sliderInput("hist_years", "(TODO) Choose between years:",
              min = 1964, max = 2018, value = c(1964, 2018), sep = ""
  )
)

renderPlot({
  # Dataframe of filtered and selected age groups from user input
  plot_df <- hist_df[hist_df$Age %in% age_groups[as.numeric(input$hist_ages)], ]
  years_label <- ggplot2:::interleave(seq(1964,2018,4), "")
  plot_title <- paste("Age Groups that", vote_status[as.numeric(input$hist_status)], "in the U.S.")
  count_label <- paste("Total", vote_status[as.numeric(input$hist_status)], "Count (In Thousands)")
  select_vote <- as.numeric(input$hist_status)
  # Historical plot of either total count  on votes/registratiob
  if(input$plot_change == 1) {
    plot_df %>% 
      filter(Status == vote_status[select_vote]) %>% 
      # TODO Fix years slider
      # filter(input$hist_years[1] <= Year & input$hist_years[2] >= Year) %>% 
      mutate(status_pop = (Population.Count * Population.Percent) / 100) %>% 
      ggplot() +
      aes(Year, status_pop, group = Age, color = Age) + 
      geom_point() + geom_line() + 
      ggtitle(plot_title) +
      ylab(count_label) + 
      xlab("Years") + 
      scale_x_discrete(labels = years_label) +
      theme(plot.title = element_text(hjust = .5))
  }
  # Historical plot of either votes and registration data
  else {
      plot_df <- plot_df %>% filter(Status == vote_status[select_vote])
      title_perc <- paste("Percentage Between Age Groups That", vote_status[select_vote])
      # Historical plot
      ggplot(data = plot_df) +
        aes(Year, Population.Percent, group = Age, color = Age) + 
        geom_point() + geom_line() + 
        ggtitle(title_perc) +
        ylab("Percentage") + 
        xlab("Years") + 
        scale_x_discrete(labels = years_label) +
        theme(plot.title = element_text(hjust = .5))
  }
})

renderDataTable({
  # Dataframe of filtered and selected age groups from user input
  table_df <- hist_df[hist_df$Age %in% age_groups[as.numeric(input$hist_ages)], ]
  select_vote <- as.numeric(input$hist_status)
  # Table of historical data
  table_df %>% 
    filter(Status == vote_status[select_vote]) %>% 
    mutate(status_pop = (Population.Count * Population.Percent) / 100) %>% 
    select(Year, Age, status_pop, Population.Percent) %>%
    rename(`Population Count` = status_pop) %>% 
    rename(`Population Percentage` = Population.Percent)
})
```

## Does Young Voter Turnout Drop With Race?

```{r message=FALSE, warning=FALSE, include=FALSE}
# Dataframe putting hist_df into a long format based on races
race_df <- hist_df %>% filter(Status == "Voted")
race_df <- melt(race_df, id.vars = c("Age", "Year"), 
                measure.vars = c("White.Percent", "White.Non.Hispanic.Percent",
                                 "Black.Percent", "Asian.Percent",
                                 "Hispanic.Other.Percent"))

race_df <- na.omit(race_df)
```

Looking at race for 18-24 year old voters:

```{r Plots for young voters by race, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted") %>% 
  ggplot(aes(Year, White.Percent, group = Age)) +
  geom_point(color = "blue") + geom_smooth() +
  ggtitle("White Voting Percentage Over Time") +
  scale_x_discrete(labels = years_label) +
  ylab("Voting Percentage") +
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Age == '18 to 24' & (as.character(Year) >= 1994) & Status == "Voted") %>% 
  ggplot(aes(Year, White.Non.Hispanic.Percent, group = Age)) +
  ggtitle("White (Non Hispanic) Voting Percentage Over Time") +
  geom_point(color = "Red") + geom_smooth(color = "Red") +
  ylab("Voting Percentage") +
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted") %>% 
  ggplot(aes(Year, Black.Percent, group = Age)) +
  geom_point(color = "Green") + geom_smooth(color = "Green") +
  ggtitle("Black Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))


hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted" & (as.character(Year) >= 1994)) %>% 
  ggplot(aes(Year, Asian.Percent, group = Age)) +
  geom_point(color = "Yellow") + geom_smooth(color = "Yellow") +
  ggtitle("Asian Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted" & (as.character(Year) >= 1974)) %>% 
  ggplot(aes(Year, Hispanic.Other.Percent, group = Age)) +
  geom_point(color = "Purple") + geom_smooth(color = "Purple") +
  ggtitle("Hispanic/Other Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

# TODO: Make plot colors consistant

race_df %>% 
  filter(Age == '18 to 24') %>% 
  ggplot(aes(Year, value, group = Age, color = variable)) +
  geom_point() + geom_smooth() +
  facet_wrap(~variable) +
  ggtitle("Young Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 
```

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
race_names <- c("White", "White (Non Hispanic)", 
                "Black", "Asian", "Hispanic/Other")

race_df %>% 
  filter(Age == "18 to 24") %>% 
  group_by(variable) %>%
  summarize(`Vote Count` = mean(value)) %>% 
  ggplot() +
  aes(variable, `Vote Count`, fill = variable) +
  geom_bar(stat = "identity") +
  ggtitle("Mean Votes of Young Voters by Race") +
  xlab("Races") +
  scale_x_discrete(labels = race_names)

race_df %>% 
  filter(Year == "2018" & Age != "Total") %>% 
  ggplot(aes(variable, value, fill = variable)) +
  geom_bar(stat = "identity") +
  ggtitle("Voting Percents of Young People by Race") +
  xlab("Races") +
  ylab("Voting Percentages") +
  facet_wrap(~Age) +
  scale_x_discrete(labels = race_names) +
  theme_minimal() +
  labs(variable = "Races") +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 
```

## Race Testing - Multiple Linear Regression

Could we make predictions based on race and young voters? We can build and fit a multiple linear regression model, with different races as predictor variables and young voting percentage as the outcome variable, to test if there is no significant prediction of young voters by different race groups.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Cleaning up race values
lm_race <- race_df %>% filter(Age == "18 to 24")
lm_race$variable <- as.character(lm_race$variable)
lm_race$variable[lm_race$variable == "White.Percent"] <- "White"
lm_race$variable[lm_race$variable == "White.Non.Hispanic.Percent"] <- "White (Non Hispanic)"
lm_race$variable[lm_race$variable == "Black.Percent"] <- "Black"
lm_race$variable[lm_race$variable == "Asian.Percent"] <- "Asian"
lm_race$variable[lm_race$variable == "Hispanic.Other.Percent"] <- "Hispanic or Other"
lm_race$variable <- as.factor(lm_race$variable)
lm_race <- lm_race %>% rename(race = variable) %>% rename(percentage = value)

lm_fit <- lm(percentage ~ race, data = lm_race)
summary(lm_fit) %>% pander

# TODO: Possibly other linear regression tests with races with citizenship?
```

Based on the results, (Put fitted model interpretations here). (Do we reject the null?)

```{r echo=FALSE, message=FALSE, warning=FALSE}
step(lm(percentage ~ race, data = lm_race), direction = "both", trace = 0)
```

To evaluate the model, the stepwise algorithm was used in both directions and it concluded that the current model that included all races as the coefficients is the best to use.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# TODO
plot(lm_fit$residuals ~ lm_fit$fitted.values)
abline(lm_fit, h = 0)
```

Based on a plot between residuals versus the fitted values however, there is a noticable pattern; a multiple linear regression model would probably not be the best model to use for prediction with race and young voters. 

## The Future

What could happen for young voter turnout? To predict this, we created a time series, a vector of values specifically on a the total population who voted over the years.

```{r echo=FALSE, message=FALSE, warning=FALSE}
time_df <- hist_df %>% filter(Status == "Voted" & Age == "18 to 24")
votes_vec <- time_df$Population.Percent
votes_vec <- na.omit(votes_vec)
votes_ts <- ts(votes_vec, frequency = .5, start = c(1964, 1), end = c(2018, 1))
plot.ts(votes_ts)
```

Then to create future prediction, we fitted a Holt-Winters forecasting model.

```{r echo=FALSE, message=FALSE, warning=FALSE}
fit <- HoltWinters(votes_ts, gamma = FALSE)
plot(fit)
pred <- forecast:::forecast.HoltWinters(fit, h = 5, lower = 0, upper = 100)
plot(pred)
```

Based on the model, it seems that voter turnout for young people is staying roughly the same.

## Interactive Forecasting with HoltWinters Model of Young Voters

```{r echo=FALSE, message=FALSE, warning=FALSE}
inputPanel(
  numericInput("num", "Enter amount of years to make prediction", 
               value = 5, min = 1, max = 100)
  )

renderPlot({
  pred <- forecast:::forecast.HoltWinters(fit, h = input$num[1], lower = 0, upper = 100)
  plot(pred)
})
```

