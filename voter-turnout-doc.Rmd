---
title: "Impact of Voter Age on Election Outcomes"
author: "Hans Quiogue and Jackson Callaghan"
date: "5/3/2020"
output: html_document
runtime: shiny
---
<style>
    body .main-container {
        max-width: 1000px;
    }
</style>

```{r Libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(readxl)
library(pander)
library(forecast)
library(DT)
library(reshape2)
library(kableExtra)
library(viridis)
library(shiny)
library(scales)
library(gridExtra)
library(fiftystater)
library(mapproj)
```

```{r Set Theme, message=FALSE, warning=FALSE, include=FALSE}
theme_set(theme_minimal())
```

```{r Data Cleaning for Historical Data, message=FALSE, warning=FALSE, include=FALSE}
# Uncleaned historical data
hist_df <- read_xlsx("a1.xlsx", skip = 5, na = "NA")
# Different voting category names to put into columns for the dataframe
voting_col_names <- c("Year", "Population-Count", "Population-Percent",
                      "Citizen-Percent", "White-Percent", "Citizen-White-Percent", 
                      "White-Non-Hispanic-Percent", "Citizen-White-Non-Hispanic-Perc", 
                      "Black-Percent", "Citizen-Black-Percent", "Asian-Percent",
                      "Citizen-Asian-Percent", "Hispanic/Other-Percent",
                      "Citizen-Hispanic/Other-Perc", "Male-Percent", "Female-Percent")
# Assigns proper column names 
colnames(hist_df) <- voting_col_names
# Converts all columns to numeric
hist_df[] <- lapply(hist_df, function(x) as.numeric(x))
# Converts year column to a categorical value
hist_df$Year <- as.factor(hist_df$Year)

# 1964 to 2018 (Goes by every 2 year)
years_length <- (2018 - 1964) / 2
# List of proper age groups and voting status to put into dataframe
age_groups <- c("Total", "18 to 24", "25 to 44", "45 to 64", "65+")
vote_status <- c("Voted", "Registered")

temp_df <- data.frame()

# Integer values representing current index values of corresponding list
curr_status <- 1
curr_age <- 1

# Loop to cleans up hist_df (Loop increments are added by 6 to account for missing columns)
for(i in seq(1, nrow(hist_df), years_length + 6)) {
  # Appends new rows to temp_df from subset of hist_df
  if(i != 1) temp_df <- bind_rows(temp_df, hist_df[(i - 1):((i - 1) + years_length), ])
  else temp_df <- bind_rows(temp_df, hist_df[i:(i + years_length), ])
}

# Appends new columns for age groups and voting statuses
temp_df <- data.frame(append(temp_df, c(Age = age_groups[curr_status], 
                                        Status = vote_status[curr_age]),
                                        after = 0), stringsAsFactors = FALSE)

temp_index = 1
# Loop that corrects age group and voting status rows
for(i in 1:(length(age_groups) * length(vote_status))) {
  temp_df$Age[temp_index:(temp_index + years_length)] <- age_groups[curr_age]
  temp_df$Status[temp_index:(temp_index + years_length)] <- vote_status[curr_status]
  temp_index <- (temp_index + years_length) + 1
  # Updates age group and voting status to match rows
  if(curr_status == 1) curr_status = curr_status + 1
  else {
    curr_status = 1
    curr_age = curr_age + 1
  }
}
# Removes unnessary rows at the nd
hist_df <- temp_df[1:279, ]

hist_df$Age <- as.factor(hist_df$Age)
hist_df$Status <- as.factor(hist_df$Status)
hist_df <- mutate(hist_df, election.type = ifelse(Year %in% seq(1964, 2020, 4), "Presidential", "Midterm")) 
```

TODO (Intro stuff here): "A description of what you project is about and an overview of what you did. Include the main learning goal or research question." Voter turnout intro stuff blah blah

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
years_label <- ggplot2:::interleave(seq(1964,2018,4), "")

hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  mutate(voted_count = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  aes(x = Year, group = Age) +
     geom_point(aes(y = Population.Count, color = "Eligible Population")) +
     geom_line(aes(y = Population.Count, color = "Eligible Population")) +
     geom_point(aes(y = voted_count, color = "Total Vote Count")) +
     geom_line(aes(y = voted_count, color = "Total Vote Count")) +
     labs(
       title = "Comparison Between Eligible Voters and Vote Count",
       y = "Total Population Count (In Thousands)",
       x = "Years",
       color = "Groups"
       ) + 
     scale_x_discrete(labels = years_label) +
     theme(
       plot.title = element_text(hjust = .5), 
       axis.text.x = element_text(angle = 45, hjust = 1)
       ) +
     scale_color_viridis(discrete = TRUE) +
     facet_wrap(~election.type)

hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  ggplot() +
    aes(Year, Population.Percent, group = Age, color = Age) + 
    geom_point() + geom_line() +
    ggtitle("Total Voting Percentage Over the Years") +
    ylab("Percentage") + 
    xlab("Years") + 
    scale_x_discrete(labels = years_label) +
    scale_color_viridis(discrete = TRUE) +
    theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Status == "Voted" & Age == "Total") %>% 
  ggplot() +
    aes(Year, Population.Percent, group = Age, color = Age) + 
    geom_point() + geom_smooth() +
    ggtitle("Total Voting Percentage Over the Years") +
    ylab("Percentage") + 
    xlab("Years") + 
    scale_x_discrete(labels = years_label) +
    scale_color_viridis(discrete = TRUE) +
    theme(plot.title = element_text(hjust = .5))
```

Based on the plots above, voter turnout has been steadily increasing over the years, but the gap between the total population who are eligible to vote and turnout are widening. The percentage of votes over the years has also dropped. Looking for the potential problems in voter turnout, we wanted to focus on different demographics, specifically age groups.

```{r echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
plot_title <- paste("Age Groups that Voted in the U.S. (1964-2018)")
count_label <- paste("Total Voted Count (In Thousands)")

hist_df %>% 
  filter(Status == "Voted" & Age != "Total") %>% 
  mutate(test = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  aes(Year, test, group = Age, color = Age) + 
  geom_point() + geom_line() + 
  ggtitle(plot_title) +
  ylab(count_label) + 
  xlab("Years") + 
  scale_color_viridis(discrete = TRUE) +
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

hist_df %>% 
  filter(Status == "Voted" & Age != "Total") %>% 
  mutate(test = (Population.Count * Population.Percent) / 100) %>% 
  ggplot() +
  aes(Year, test, group = Age, color = Age) + 
  geom_point() + geom_smooth() + 
  ggtitle(plot_title) +
  ylab(count_label) + 
  xlab("Years") + 
  scale_color_viridis(discrete = TRUE) +
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

hist_df %>%
  filter(Status == "Voted" & Age != 'Total') %>% 
  ggplot() +
  aes(Age, Population.Percent, fill = Age) +
  geom_boxplot() +
  ggtitle("Mean Voting Percentages Between Age Groups") + 
  ylab("Mean Voting Percentage") +
  xlab("Age Groups") + 
  scale_color_viridis(discrete = TRUE) +
  theme(plot.title = element_text(hjust = .5))

mean_table <- hist_df %>% 
  filter(Status == "Voted") %>% 
  group_by(Age) %>% 
  summarize(`Mean of Age Groups` = mean(Population.Percent)) %>% 
  rename(`Age Groups` = Age)

datatable(mean_table)
```

From the plots, it seems that young voters seem to have the least turnout compared to other groups. 

## Interactive Plots on Voting and Registration Berween Age Groups

```{r Overall Votes and Registration, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
inputPanel(
  selectInput("plot_change", "Choose a plot:", 
              choices = list("Total Count" = 1, 
                              "Percentage" = 2),
              selected = 1),
  checkboxGroupInput("hist_ages", "Choose an age group:",
                      choices = list("Total" = 1,"Young" = 2,
                                     "Adult" = 3,"Mid Age" = 4,
                                     "Elderly" = 5),
                      selected = c(1, 2, 3, 4, 5)),
  radioButtons("hist_status", "Choose voting status:",
               choices = list("Voted" = 1, "Registered" = 2),
               selected = 1),
  sliderInput("hist_years", "(TODO) Choose between years:",
              min = 1964, max = 2018, value = c(1964, 2018), sep = ""
  )
)

renderPlot({
  # Dataframe of filtered and selected age groups from user input
  plot_df <- hist_df[hist_df$Age %in% age_groups[as.numeric(input$hist_ages)], ]
  years_label <- ggplot2:::interleave(seq(1964,2018,4), "")
  plot_title <- paste("Age Groups that", vote_status[as.numeric(input$hist_status)], "in the U.S.")
  count_label <- paste("Total", vote_status[as.numeric(input$hist_status)], "Count (In Thousands)")
  select_vote <- as.numeric(input$hist_status)
  # Historical plot of either total count  on votes/registratiob
  if(input$plot_change == 1) {
    plot_df %>% 
      filter(Status == vote_status[select_vote]) %>% 
      # TODO Fix years slider
      # filter(input$hist_years[1] <= Year & input$hist_years[2] >= Year) %>% 
      mutate(status_pop = (Population.Count * Population.Percent) / 100) %>% 
      ggplot() +
      aes(Year, status_pop, group = Age, color = Age) + 
      geom_point() + geom_line() + 
      ggtitle(plot_title) +
      ylab(count_label) + 
      xlab("Years") + 
      scale_x_discrete(labels = years_label) +
      scale_color_viridis(discrete = TRUE) +
      theme(plot.title = element_text(hjust = .5))
  }
  # Historical plot of either votes and registration data
  else {
      plot_df <- plot_df %>% filter(Status == vote_status[select_vote])
      title_perc <- paste("Percentage Between Age Groups That", vote_status[select_vote])
      # Historical plot
      ggplot(data = plot_df) +
        aes(Year, Population.Percent, group = Age, color = Age) + 
        geom_point() + geom_line() + 
        ggtitle(title_perc) +
        ylab("Percentage") + 
        xlab("Years") + 
        scale_x_discrete(labels = years_label) +
        scale_color_viridis(discrete = TRUE) +
        theme(plot.title = element_text(hjust = .5))
  }
})

renderDataTable({
  # Dataframe of filtered and selected age groups from user input
  table_df <- hist_df[hist_df$Age %in% age_groups[as.numeric(input$hist_ages)], ]
  select_vote <- as.numeric(input$hist_status)
  # Table of historical data
  table_df %>% 
    filter(Status == vote_status[select_vote]) %>% 
    mutate(status_pop = (Population.Count * Population.Percent) / 100) %>% 
    select(Year, Age, status_pop, Population.Percent) %>%
    rename(`Population Count` = status_pop) %>% 
    rename(`Population Percentage` = Population.Percent)
})
```

## Does Young Voter Turnout Drop With Race?

```{r message=FALSE, warning=FALSE, include=FALSE, fig.width=10, fig.fullwidth=TRUE}
# Dataframe putting hist_df into a long format based on races
race_df <- hist_df %>% filter(Status == "Voted")
race_df <- melt(race_df, id.vars = c("Age", "Year"), 
                measure.vars = c("White.Percent", "White.Non.Hispanic.Percent",
                                 "Black.Percent", "Asian.Percent",
                                 "Hispanic.Other.Percent"))

race_df <- na.omit(race_df)
```

Looking at race for 18-24 year old voters:

```{r Plots for young voters by race, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# TODO: Make plot colors consistant

# Individual White plot
hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted") %>% 
  ggplot(aes(Year, White.Percent, group = Age)) +
  geom_point(color = "blue") + geom_smooth() +
  ggtitle("White Voting Percentage Over Time") +
  scale_x_discrete(labels = years_label) +
  ylab("Voting Percentage") +
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

# Individual White Non Hispanic Plot
hist_df %>% 
  filter(Age == '18 to 24' & (as.character(Year) >= 1994) & Status == "Voted") %>% 
  ggplot(aes(Year, White.Non.Hispanic.Percent, group = Age)) +
  ggtitle("White (Non Hispanic) Voting Percentage Over Time") +
  geom_point(color = "Red") + geom_smooth(color = "Red") +
  ylab("Voting Percentage") +
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5)) 

# Individual Black Plot
hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted") %>% 
  ggplot(aes(Year, Black.Percent, group = Age)) +
  geom_point(color = "Green") + geom_smooth(color = "Green") +
  ggtitle("Black Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  scale_x_discrete(labels = years_label) +
  theme(plot.title = element_text(hjust = .5))

# Individual Asian Plot
hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted" & (as.character(Year) >= 1994)) %>% 
  ggplot(aes(Year, Asian.Percent, group = Age)) +
  geom_point(color = "Yellow") + geom_smooth(color = "Yellow") +
  ggtitle("Asian Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

# Individual Hispanic/Other Plot
hist_df %>% 
  filter(Age == '18 to 24' & Status == "Voted" & (as.character(Year) >= 1974)) %>% 
  ggplot(aes(Year, Hispanic.Other.Percent, group = Age)) +
  geom_point(color = "Purple") + geom_smooth(color = "Purple") +
  ggtitle("Hispanic/Other Voting Percentage Over Time") +
  ylab("Voting Percentage") + 
  xlab("Years") +
  theme(plot.title = element_text(hjust = .5))

# Total Race Plots 
race_df %>% 
  filter(Age == "Total") %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_smooth(se = FALSE) +
  ggtitle("Total Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_x_discrete(labels = years_label) +
  scale_color_viridis(discrete = TRUE) +
  theme(plot.title = element_text(hjust = .5))

# Total Race Plots 
race_df %>% 
  filter(Age == "Total") %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_line() +
  ggtitle("Total Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_x_discrete(labels = years_label) +
  scale_color_viridis(discrete = TRUE) +
  theme(plot.title = element_text(hjust = .5))


# All Ages and Race Plots Facetted
race_df %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_smooth(se = FALSE) +
  facet_wrap(~Age) +
  ggtitle("Total Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_color_viridis(discrete = TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 

# All Ages and Race Plots Facetted
race_df %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_line() +
  facet_wrap(~Age) +
  ggtitle("Total Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 

# Young People and Race
race_df %>% 
  filter(Age == '18 to 24') %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_smooth(se = FALSE) +
  ggtitle("Young Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_x_discrete(labels = years_label) +
  scale_color_viridis(discrete = TRUE) +
  theme(plot.title = element_text(hjust = .5))

race_df %>% 
  filter(Age == '18 to 24') %>% 
  ggplot(aes(Year, value, group = variable, color = variable)) +
  geom_point() + geom_line() +
  ggtitle("Young Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_x_discrete(labels = years_label) +
  scale_color_viridis(discrete = TRUE) +
  theme(plot.title = element_text(hjust = .5))

# Young Voters and Race Facetted
race_df %>% 
  filter(Age == '18 to 24') %>% 
  ggplot(aes(Year, value, group = Age, color = variable)) +
  geom_point() + geom_smooth() +
  facet_wrap(~variable) +
  ggtitle("Young Voters and Race") +
  ylab("Voting Percentage") +
  xlab("Years (1964-2018)") +
  labs(color = "Races") +
  scale_color_viridis(discrete = TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
race_val_names <- c("White.Percent", "White.Non.Hispanic.Percent",
                    "Black.Percent", "Asian.Percent",
                    "Hispanic.Other.Percent")

race_names <- c("White", "White (Non Hispanic)", 
                "Black", "Asian", "Hispanic/Other")

inputPanel(
  selectInput("plot_race", "Choose a plot:", 
              choices = list("Total Count" = 1, 
                              "Young Voters" = 2),
              selected = 1),
  checkboxGroupInput("race", "Choose a race group:",
                      choices = list("White" = 1,"White (Non Hispanic)" = 2,
                                     "Black" = 3,"Asian" = 4,
                                     "Hispanic/Other" = 5),
                      selected = c(1, 2, 3, 4, 5)),
  radioButtons("status", "Choose voting status:",
               choices = list("Voted" = 1, "Registered" = 2),
               selected = 1)
  )


gen_race_df <- function() {
  race_num <- as.numeric(input$race)
  status_num <- as.numeric(input$status)
  # Dataframe putting hist_df into a long format based on races
  race_df <- hist_df %>% filter(Status == vote_status[status_num])
  race_df <- melt(race_df, id.vars = c("Age", "Year"), 
                  measure.vars = race_val_names)
  race_df <- na.omit(race_df)
  # Dataframe of filtered and selected age groups from user input
  race_df <- race_df[race_df$variable %in% race_val_names[race_num], ]
  
  if(input$plot_race == 1) {
    race_df <- race_df %>% filter(Age == "Total")
  }
  else {
    race_df <- race_df %>% filter(Age == "18 to 24")
  }
  
  race_df$variable <- as.character(race_df$variable)
  race_df$variable[race_df$variable == "White.Percent"] <- "White"
  race_df$variable[race_df$variable == "White.Non.Hispanic.Percent"] <- "White (Non Hispanic)"
  race_df$variable[race_df$variable == "Black.Percent"] <- "Black"
  race_df$variable[race_df$variable == "Asian.Percent"] <- "Asian"
  race_df$variable[race_df$variable == "Hispanic.Other.Percent"] <- "Hispanic or Other"
  race_df$variable <- as.factor(race_df$variable)
  race_df
}

renderPlot({
  plot_df <- gen_race_df()
  plot_title <- paste("Total", vote_status[as.numeric(input$status)], "by Race")
  y_title <- paste("Percentage (", vote_status[as.numeric(input$status)], ")", sep = "")
  plot_df %>% 
    ggplot(aes(Year, value, group = variable, color = variable)) +
    geom_point() + geom_line() +
    ggtitle(plot_title) +
    ylab(y_title) +
    xlab("Years (1964-2018)") +
    labs(color = "Races") +
    scale_x_discrete(labels = years_label) +
    scale_color_viridis(discrete = TRUE) +
    theme(plot.title = element_text(hjust = .5))
})

renderDataTable({
  table_df <- gen_race_df()
  
  table_df %>% 
    rename(`Race Groups` = variable,
           Percentages = value)
})

```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
race_df %>% 
  filter(Age == "18 to 24") %>% 
  group_by(variable) %>%
  summarize(`Vote Count` = mean(value)) %>% 
  ggplot() +
  aes(variable, `Vote Count`, fill = variable) +
  geom_bar(stat = "identity") +
  ggtitle("Mean Votes of Young Voters by Race") +
  xlab("Races") +
  scale_x_discrete(labels = race_names) + 
  scale_color_viridis(discrete = TRUE)

race_df %>% 
  filter(Year == "2018" & Age != "Total") %>% 
  ggplot(aes(variable, value, fill = variable)) +
  geom_bar(stat = "identity") +
  ggtitle("Voting Percents of Young People by Race") +
  xlab("Races") +
  ylab("Voting Percentages") +
  facet_wrap(~Age) +
  scale_x_discrete(labels = race_names) +
  theme_minimal() +
  labs(variable = "Races") +
  scale_color_viridis(discrete = TRUE) +
  theme(axis.text.x = element_blank(),
        plot.title = element_text(hjust = .5)) 

race_df %>% 
  filter(Age == "Total") %>% 
  ggplot() +
  aes(variable, value, fill = variable) +
  geom_boxplot() +
  ggtitle("Votes of Total Voters by Race") +
  xlab("Races") +
  scale_color_viridis(discrete = TRUE) +
  scale_x_discrete(labels = race_names)

race_df %>% 
  filter(Age == "18 to 24") %>% 
  ggplot() +
  aes(variable, value, fill = variable) +
  geom_boxplot() +
  ggtitle("Votes of Young Voters by Race") +
  xlab("Races") +
  scale_color_viridis(discrete = TRUE) +
  scale_x_discrete(labels = race_names)
```

## Race Testing - Multiple Linear Regression

Based on the boxplot, it seems that young asians and hispanics (or other races) vote the least compared to other races. Could we predict these two racesCould we make predictions based on race and young voters? We can build and fit a multiple linear regression model, with different races as predictor variables and young voting percentage as the outcome variable, to test if there is no significant prediction of young voters by different race groups.

We can conduct a formal F test using ANOVA to compare our specified model we want to fit to another with no independent variables.

- The null hypothesis states that the model with no independent variables fits the data as well as your model
- The alternative hypothesis says that your model fits the data better 

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# Cleaning up race values
lm_race <- race_df %>% filter(Age == "18 to 24")
lm_race$variable <- as.character(lm_race$variable)
lm_race$variable[lm_race$variable == "White.Percent"] <- "White"
lm_race$variable[lm_race$variable == "White.Non.Hispanic.Percent"] <- "White (Non Hispanic)"
lm_race$variable[lm_race$variable == "Black.Percent"] <- "Black"
lm_race$variable[lm_race$variable == "Asian.Percent"] <- "Asian"
lm_race$variable[lm_race$variable == "Hispanic.Other.Percent"] <- "Hispanic or Other"
lm_race$variable <- as.factor(lm_race$variable)
lm_race <- lm_race %>% rename(race = variable) %>% rename(percentage = value)

summary(aov(percentage ~ race, data = lm_race)) %>% pander

```

Since the p-value is significantly less than the specified significance level of .05, we reject the null hypothesis. There is statistical evidence that our model fits the data better. Hence, we could attempt fitting a multiple linear regression model. 

### Fitting the model

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
lm_fit <- lm(percentage ~ race, data = lm_race)
summary(lm_fit) %>% pander
```

Based on the results, since none of the coefficients were equal to 0, the races are statistically significant.

Interpretations we could make based on our hypothesis:

- If an indivual was hispanic (or another race), the approximate voting percentage would be .47%

- If an indivual was asian, the approximate voting percentage would be 16.162%

.. and so on

Comparing all the races together, it seems that they all have similar voting percentage outcomes, with the exception of hispanics (or other races). Due to the low R squared and adjusted R squared values however, it seems that the current model could be somewhat unreliable.  

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
step(lm(percentage ~ race, data = lm_race), direction = "both", trace = 0)
```

To evaluate the model, the stepwise algorithm was used in both directions and it concluded that the current model that included all races as the coefficients is the best to use.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# TODO
plot(lm_fit$residuals ~ lm_fit$fitted.values)
abline(lm_fit, h = 0)
```

Based on a plot between residuals versus the fitted values however, there is a noticable pattern; a multiple linear regression model would probably not be the best model to use for prediction with race and young voters. More tests should be performed. 

## The Future

What could happen for young voter turnout? To predict this, we created a time series, a vector of values specifically on a the total population who voted over the years.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
time_df <- hist_df %>% filter(Status == "Voted" & Age == "18 to 24")
votes_vec <- time_df$Population.Percent
votes_vec <- na.omit(votes_vec)
votes_ts <- ts(votes_vec, frequency = .5, start = c(1964, 1), end = c(2018, 1))
plot.ts(votes_ts)
```

Then to create future prediction, we fitted a Holt-Winters forecasting model.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
fit <- HoltWinters(votes_ts, gamma = FALSE)
plot(fit)
pred <- forecast:::forecast.HoltWinters(fit, h = 5, lower = 0, upper = 100)
plot(pred)
```

Based on the model, it seems that voter turnout for young people is staying roughly the same.

## Interactive Forecasting with HoltWinters Model of Young Voters

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
inputPanel(
  numericInput("num", "Enter amount of years to make prediction", 
               value = 5, min = 1, max = 100)
  )

renderPlot({
  pred <- forecast:::forecast.HoltWinters(fit, h = input$num[1], lower = 0, upper = 100)
  plot(pred)
})
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# keeping this as a template
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# read in age demographics
raw.byage <- read_excel(
  "CPS Turnout Rates.xlsx",
  sheet = "Age",
  range = "A2:R6"
)

# pivot to tidy shape
byage <- raw.byage %>% 
  pivot_longer(cols = 2:length(raw.byage), names_to = "year", values_to = "turnout")
colnames(byage)[1] = "age.group"
# change types and mutate new type column
byage$year <- as.numeric(byage$year)
byage <- byage %>% mutate(type = ifelse(year %in% seq(1986, 2020, 4), "Midterm", "Presidential"))
byage$type <- factor(byage$type, levels = c("Presidential", "Midterm"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
# read in age demographics
raw.byedu <- read_excel(
  "CPS Turnout Rates.xlsx",
  sheet = "Education",
  range = "A2:R6"
)

# pivot to tidy shape
byedu <- raw.byedu %>% 
  pivot_longer(cols = 2:length(raw.byedu), names_to = "year", values_to = "turnout")
colnames(byedu)[1] = "edu_lvl"
# change types and mutate new type column
byedu$year <- as.numeric(byedu$year)
byedu <- byedu %>% mutate(type = ifelse(year %in% seq(1986, 2020, 4), "Midterm", "Presidential"))
byedu$type <- factor(byedu$type, levels = c("Presidential", "Midterm"))
byedu$edu_lvl <- factor(byedu$edu_lvl, levels = c("Less Than High School", "High School Grad", "Some College to College Grad", "Post-Graduate"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
raw.alltime <- read_csv("U.S. VEP Turnout 1789-Present - Statistics.csv")
all.pres <- raw.alltime[, 1:2]
all.midt <- raw.alltime[, 3:4]
colnames(all.pres) <- c("year", "turnout")
colnames(all.midt) <- c("year", "turnout")

all.pres$type <- rep("Presidential", nrow(all.pres))
all.midt$type <- rep("Midterm", nrow(all.midt))

alltime <- full_join(all.pres, all.midt)
alltime$type <- factor(alltime$type, levels = c("Presidential", "Midterm"))
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
pres.results <- read_csv("1976-2016-president.csv")

party.results <- pres.results %>% 
      # full_join(select(sena.results, -district)) %>% 
      # full_join(select(hous.results, -district)) %>% 
      filter(writein == FALSE) %>% 
      filter(year != 2018) %>% 
      mutate(party = replace(party, party == "democratic-farmer-labor", "democrat")) %>% 
      filter(party %in% c("democrat", "republican")) %>% 
      select(-candidate) %>% 
      pivot_wider(
          names_from = party,
          values_from = candidatevotes,
          values_fill = list(democrat = 0, republican = 0)
      ) %>% 
      # filter(totalvotes != 1) %>% 
      # party.results$democrat <- unlist(party.results$democrat, use.names = FALSE)
      mutate(p.dem = democrat / totalvotes) %>% 
      mutate(p.rep = republican / totalvotes) %>% 
      mutate(partyscore = p.rep - p.dem)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
gen.turn <- read_excel(
        "1980-2014 November General Election.xlsx",
        skip = 1
    )
    
    gen.turn.2016 = read_excel(
        "2016 November General Election.xlsx",
        skip = 1
    )
    
    gen.turn <- gen.turn %>%
        select(-(2:3), -c(5, 7, 8, 11), -(12:17)) 
    
    colnames(gen.turn) <- c("year", "region", "turnout", "ballots", "VEP")
    gen.turn$region <- sapply(gen.turn$region, tolower)
    gen.turn <- mutate(gen.turn, type = ifelse(year %in% seq(1980, 2020, 4), "Presidential", "Midterm"))
    
    gen.turn.2016 <- gen.turn.2016 %>%
        select(-(2:3), -c(4, 6, 7, 10), -(11:17)) 
    
    colnames(gen.turn.2016) <- c("region", "turnout", "ballots", "VEP")
    gen.turn.2016$region <- sapply(gen.turn.2016$region, tolower)
    gen.turn.2016$year <- rep(2016, nrow(gen.turn.2016))
    gen.turn.2016$type <- rep("Presidential", nrow(gen.turn.2016))
    
    gen.turn <- full_join(gen.turn, gen.turn.2016)
    
    states.turnout <- gen.turn %>% filter(region != "united states")
    total.turnout <- gen.turn %>% filter(region == "united states")
    
party.results.mergeprep <- party.results %>% 
  mutate(state = tolower(state)) %>% 
  filter(year %in% seq(1980, 2016, 4))

states.turnout.mergeprep <- states.turnout %>% 
  filter(year %in% seq(1980, 2016, 4)) %>% 
  rename(state = region)

test2 <- full_join(party.results.mergeprep, states.turnout.mergeprep)

test2 <- test2 %>% 
  group_by(state) %>% 
  summarize(mean_state_score = mean(partyscore)) %>% 
  full_join(test2)

results <- read_csv("1976-2016-president.csv")
    party.results <- results %>% 
        mutate(party = replace(party, party == "democratic-farmer-labor", "democrat")) %>% 
        filter(party %in% c("democrat", "republican")) %>% 
        filter(writein == FALSE) %>% 
        select(-candidate) %>% 
        pivot_wider(
            names_from = party,
            values_from = candidatevotes
        ) %>% 
        mutate(p.dem = democrat / totalvotes) %>% 
        mutate(p.rep = republican / totalvotes) %>% 
        mutate(partyscore = p.rep - p.dem)
```

## A few plots

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
ggplot(byage) +
  aes(
    x = as.factor(year), 
    y = turnout, 
    color = age.group, 
    group = age.group) +
  geom_line(size = 1) +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(x = "Year", y = "Turnout", title = "Election Turnout", color = "Age Group") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE) +
  facet_wrap(~type, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(alltime) +
  aes(
    x = year, 
    y = turnout, 
    color = type, 
    group = type) +
  geom_line(size = 1) +
  ylim(0, 100) +
  labs(x = "Year", y = "Turnout", title = "Overall Election Turnout", color = "Election Type") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Per-State turnout and party score

```{r echo=FALSE, message=FALSE, warning=FALSE}
inputPanel(
  sliderInput("year", "Year", 1980, 2016, 2016, step = 2, animate = TRUE, sep = ""),
  checkboxInput(
      "relscale",
      "Use relative color scale",
      TRUE
  )
)

  splitLayout(
  renderPlot({
          
          # merge <- states.turnout %>% 
          #     filter(year == input$year)
          # 
          # merge <- inner_join(states_map, merge, by = "region")
          
          data("fifty_states")
          
          ret_plot <- states.turnout %>% 
              filter(year == input$year) %>% 
              ggplot(aes(map_id = region)) +
                  geom_map(aes(fill = turnout), map = fifty_states, color = "white") +
                  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
                  coord_map(projection = "albers", lat0=30, lat1=40) +
                  labs(title = paste("Election Turnout Rates by State (", input$year, ")", sep = ""), fill = "Turnout") +
                  theme_void() +
                  fifty_states_inset_boxes() + 
                  facet_wrap(~type)
          
          if (input$relscale) {
              ret_plot + scale_fill_viridis(label = scales::percent)
          }
          else {
              ret_plot + scale_fill_viridis(limits = c(0, 1), label = scales::percent)
          }
      }
      # cache = diskCache(),
      # cacheKeyExpr = input$year
     ),
  
  renderPlot({
          party.results %>% 
              filter(year == input$year) %>% 
              ggplot(aes(map_id = tolower(state))) + # map_id must be lowercase for whatever reason
                  geom_map(aes(fill = partyscore), map = fifty_states, color = "lightgrey") +
                  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
                  coord_map(projection = "albers", lat0=30, lat1=40) +
                  labs(title = paste("Presidential Popular Vote Leaning by State (", input$year, ")", sep = ""), fill = "Party Score (-1 = 100% Democrat, 1 = 100% Republican)") +
                  theme_void() +
                  scale_fill_gradient2(
                      low = "blue", 
                      mid = "white", 
                      high = "red", 
                      limits = c(-1, 1),
                      guide = guide_colorbar(title.position = "top")
                  ) +
                  theme(legend.position = "bottom", legend.box = "horizontal") +
                  fifty_states_inset_boxes()
      }
      # cache = diskCache(),
      # cacheKeyExpr = input$year
      )
)
```



## Testing overall turnout vs party score

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
test2 %>% 
  filter(year >= 2000) %>% 
  ggplot() +
    aes(x = turnout, y = partyscore) +
    geom_point() +
    geom_smooth(method = "lm")
    # facet_wrap(~year)

test2 %>% 
  filter(year >= 2000) %>% 
  ggplot() +
    aes(x = turnout, y = partyscore) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~year)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
turn.res.2000 <- test2 %>% 
  filter(year >= 2000)

fit.turn.res <- lm(partyscore ~ turnout, data = turn.res.2000)
plot(fit.turn.res)
summary(fit.turn.res)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
hist.age.turnout <- hist_df %>% 
  filter(Year %in% seq(1964, 2016, 4)) %>% 
  filter(Status == "Voted") %>% 
  filter(Age != "Total") %>% 
  filter(election.type == "Presidential") %>% 
  rename(year = Year)

hist.age.turnout.res <- party.results %>% 
  select(year, state, partyscore) %>% 
  mutate(state = tolower(state)) %>% 
  pivot_wider(names_from = state, values_from = partyscore) %>% 
  mutate(country_mean = rowMeans(select(., alabama:`wyoming`))) %>% 
  filter(year %in% seq(1964, 2016, 4)) %>% 
  select(year, country_mean) %>%
  mutate(year = as.factor(year)) %>% 
  full_join(hist.age.turnout) %>% 
  mutate(year = as.numeric(year)) %>% 
  filter(year >= 1976)
```

with ronald reagan:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
hist.age.turnout.res %>% 
  # filter(!(year %in% c(1980, 1984))) %>% 
  ggplot() +
    aes(x = Population.Percent, y = country_mean, color = Age) +
    geom_point() +
    geom_smooth(method = "lm")

filter(hist.age.turnout.res, Age == "18 to 24")

with.reagan <- lm(country_mean ~ Population.Percent, data = filter(hist.age.turnout.res, Age == "18 to 24"))
plot(with.reagan)
summary(with.reagan)
```

without ronald reagan:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.fullwidth=TRUE}
hist.age.turnout.res %>% 
  filter(!(year %in% c(1980, 1984))) %>%
  ggplot() +
    aes(x = Population.Percent, y = country_mean, color = Age) +
    geom_point() +
    geom_smooth(method = "lm")

filter(hist.age.turnout.res, Age == "18 to 24")

data.without.reagan <- hist.age.turnout.res %>% 
  filter(!(year %in% c(1980, 1984))) %>%
  filter(Age == "18 to 24")

with.reagan <- lm(country_mean ~ Population.Percent, data = data.without.reagan)
plot(with.reagan)
summary(with.reagan)
```